<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.glxy.sass.mapper.CompetitionMapper">

    <resultMap id="competitionMap" type="org.glxy.sass.entity.Competition">
        <id column="competition_nb" property="competitionNb"/>
        <result column="competition_ne" property="competitionNe"/>
        <result column="competition_start" property="competitionStart"/>
        <result column="competition_end" property="competitionEnd"/>
        <result column="competition_site" property="competitionSite"/>
        <collection property="iusersList" ofType="org.glxy.sass.entity.Users" javaType="ArrayList">
            <id column="users_stnumber" property="usersStnumber"/>
            <result column="users_name" property="usersName"/>
            <result column="users_sex" property="usersSex"/>
            <result column="users_phone" property="usersPhone"/>
            <result column="college_name" property="collegeName"/>
        </collection>
    </resultMap>

    <!--    比赛新增（新）-->
    <insert id="addCompetition" parameterType="org.glxy.sass.entity.Competition">
        insert into
        competition(competition_nb,
        competition_ne,
        competition_site,
        competition_pe,
        competition_tnor,
        competition_start,
        competition_end,
        apply_start,
        apply_end)
        values (#{competitionNb},
        #{competitionNe},
        #{competitionSite},
        #{competitionPe},
        #{competitionTnor},
        #{competitionStart},
        #{competitionEnd},
        #{applyStart},
        #{applyEnd}
        )
    </insert>

    <!--    参赛剩余人数减1 -->
    <update id="updateCompetition" parameterType="org.glxy.sass.entity.Enroll">
        UPDATE competition SET competition_tnor = competition_tnor - 1
        WHERE competition_nb = #{competitionNb}
    </update>

    <!--    参赛剩余人数加1 -->
    <update id="updateCompetitionTnor">
        UPDATE competition SET competition_tnor = competition_tnor + 1
        WHERE competition_nb = #{competitionNb}
    </update>


    <!--    查询报名时间结束的用户报名表和用户报名信息比赛信息-->
    <select id="selectByEnroll" resultType="org.glxy.sass.entity.Enroll">
--         SELECT
--         -- c.apply_end,
--         c.competition_nb,
--         c.competition_ne,
--         c.competition_start,
--         c.competition_end,
--         c.competition_site,
--         u.users_name,
--         u.users_stnumber,
--         u.users_sex,
--         u.users_phone,
--         u.college_name
--         FROM
--         competition AS c
--         LEFT JOIN users AS u ON u.competition_nb = c.competition_nb
--         WHERE
--         c.apply_end  &lt; CURRENT_TIMESTAMP()

        SELECT
        competition.competition_nb,
        competition.competition_ne,
        competition.competition_start,
        competition.competition_end,
        competition.competition_site,
        users.users_name,
        users.users_stnumber,
        users.users_sex,
        users.users_phone,
        users.college_name
        FROM
        competition
        LEFT OUTER JOIN applicationform ON applicationform.competition_nb = competition.competition_nb
        RIGHT OUTER JOIN users ON applicationform.users_stnumber = users.users_stnumber where competition.competition_nb is not null
       <!--  WHERE competition.apply_end &lt; CURRENT_TIMESTAMP () -->

    </select>


    <!--    </select>-->
    <!--根据学号名字，时间段模糊查询-->
    <select id="selectByNb" resultType="org.glxy.sass.entity.Competition">
        select * from competition
        <where>

            <if test="competitionNe != null ">
                AND competition_ne LIKE CONCAT('%','${competitionNe}','%')
            </if>
            <if test="competitionStart != null and competitionStart != '' ">
                AND competition_start &gt;= #{competitionStart}
            </if>
            <if test="competitionEnd != null and competitionEnd != '' ">
                AND competition_end &lt;= #{competitionEnd}
            </if>

        </where>
    </select>
    <select id="selectCompetitionTnor" resultType="integer">
            SELECT competition_tnor FROM competition WHERE competition_nb = #{competitionNb}
    </select>

    <!--    查询比赛报名结束时间（用户取消报名）-->
    <select id="selectApplyEnd" resultType="org.glxy.sass.entity.Competition">
	SELECT competition.apply_end FROM competition
	LEFT JOIN applicationform on applicationform.competition_nb = competition.competition_nb
	WHERE
	applicationform.users_stnumber = #{usersStnumber}
	AND competition.competition_nb = #{competitionNb}
	AND competition.apply_end &lt; CURRENT_TIMESTAMP ()
    </select>

    <!--    查询比赛是否超过报名时间-->
    <select id="selectEnd" resultType="org.glxy.sass.entity.Competition">
        SELECT apply_end FROM competition
        WHERE competition.competition_nb = #{competitionNb}
        AND competition.apply_end &lt; CURRENT_TIMESTAMP ()
    </select>

    <!--    查询比赛参赛性别是否为男-->
    <select id="selectCompetitionSex" resultType="org.glxy.sass.entity.Competition">
		SELECT competition.competition_ne FROM competition
		WHERE competition.competition_ne LIKE CONCAT('%','男','%') AND competition.competition_nb = #{competitionNb}
    </select>

    <!--    查询比赛参赛性别是否为女-->
    <select id="selectCompetitionSexGirl" resultType="org.glxy.sass.entity.Competition">
        SELECT competition.competition_ne FROM competition
		WHERE competition.competition_ne LIKE CONCAT('%','女','%') AND competition.competition_nb = #{competitionNb}
    </select>

    <!--    以场地查询比赛-->
    <select id="selectCompetitionSite" resultType="org.glxy.sass.entity.Competition">
        SELECT competition_nb FROM competition
        WHERE competition_site = #{competitionSite}
    </select>

    <!--根据比赛编号删除比赛-->
    <delete id="delete" parameterType="org.glxy.sass.entity.Competition">
        delete from competition where competition_nb = #{competitionNb}
    </delete>


    <!--    删除比赛用户报名记录-->
    <delete id="deleteComUser" parameterType="org.glxy.sass.entity.Competition">
        delete from enroll
        where users_stnumber = #{usersStnumber} and competition_nb = #{competitionNb}
    </delete>

</mapper>